#!/usr/bin/env sh
# SECURITY: Pre-commit hook to prevent committing secrets
# This hook runs Secretlint to scan staged files for leaked credentials

. "$(dirname -- "$0")/_/husky.sh"

echo "üîí Running secret scan on staged files..."

# Check if there are any staged files (null-delimited check)
if ! git diff --cached --name-only --diff-filter=ACM -z | grep -qz .; then
  echo "‚úì No files staged, skipping secret scan"
  exit 0
fi

# SECURITY: Use null-delimited input (-z) and xargs -0 to safely pass filenames to Secretlint.
# This prevents:
# - Option injection (filenames starting with -, e.g., --config=malicious)
# - Word splitting (filenames with spaces)
# - Glob expansion (filenames with wildcards like *, ?)
# The -- after secretlint ensures all arguments are treated as filenames, not options.

# Detect if xargs supports -r (run only if input is non-empty; GNU extension)
if echo | xargs -r true >/dev/null 2>&1; then
  XR=-r
else
  XR=
fi

# Run Secretlint with safe argument passing
git diff --cached --name-only --diff-filter=ACM -z | xargs -0 ${XR} npx secretlint --

# Capture exit code
SECRETLINT_EXIT=$?

if [ $SECRETLINT_EXIT -ne 0 ]; then
  echo ""
  echo "‚ùå SECRET DETECTED! Commit blocked."
  echo ""
  echo "Secrets or sensitive data found in your staged files."
  echo "Please remove sensitive information before committing."
  echo ""
  echo "If this is a false positive, you can:"
  echo "1. Add an exception to .secretlintrc.json"
  echo "2. Use git commit --no-verify (NOT recommended)"
  echo ""
  exit 1
fi

echo "‚úì Secret scan passed"
exit 0
