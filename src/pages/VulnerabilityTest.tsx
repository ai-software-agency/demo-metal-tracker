import { useState } from "react";
import { useToast } from "@/hooks/use-toast";
import { Input } from "@/components/ui/input";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { validateEmail, looksLikePAN, sanitizeCreditCardInput } from "@/utils/validation";

type TabKey = "spot-prices" | "futures" | "vulnerabilities" | "admin";

const VulnerabilityTest = ({ onNavigate }: { onNavigate?: (tab: TabKey) => void }) => {
  return (
    <div className="min-h-screen bg-background">
      <div className="container mx-auto px-4 py-8">
        <div className="mb-8">
          <h1 className="text-4xl font-bold mb-4 text-foreground">Security Vulnerability Testing Suite</h1>
          <p className="text-muted-foreground">
            ‚ö†Ô∏è This page intentionally contains security vulnerabilities for testing purposes only!
          </p>
        </div>

        <div className="grid gap-6 mb-8">
          <Card className="p-6 bg-destructive/5 border-destructive">
            <h2 className="text-2xl font-bold mb-4 text-destructive">Vulnerability Catalog</h2>
            <div className="grid md:grid-cols-2 gap-4">
              <div>
                <h3 className="font-bold mb-2">1. Leaked Secret</h3>
                <p className="text-sm text-muted-foreground mb-2">Hardcoded credentials in source code</p>
                <Button size="sm" onClick={() => onNavigate?.("admin")}>View Admin Panel</Button>
              </div>
              <div>
                <h3 className="font-bold mb-2">2. Unprotected Routes</h3>
                <p className="text-sm text-muted-foreground mb-2">Client-side admin flag, weak auth</p>
                <Button size="sm" onClick={() => onNavigate?.("admin")}>Test Admin Access</Button>
              </div>
              <div>
                <h3 className="font-bold mb-2">3. Missing Input Validation</h3>
                <p className="text-sm text-muted-foreground mb-2">Forms accept invalid inputs</p>
                <p className="text-sm text-muted-foreground">See form below</p>
              </div>
            </div>
          </Card>
        </div>

        <VulnerableFormInline />

        <Card className="p-6 mt-6 bg-primary/5">
          <h3 className="font-bold mb-2">üìö Testing Resources</h3>
          <ul className="text-sm space-y-1 text-muted-foreground">
            <li>‚Ä¢ Use browser DevTools to inspect exposed secrets</li>
            <li>‚Ä¢ Check console logs for plaintext credentials</li>
            <li>‚Ä¢ Try manipulating localStorage to bypass auth</li>
            <li>‚Ä¢ Test IDOR by changing user IDs in profile viewer</li>
            <li>‚Ä¢ Inject HTML/JavaScript in comment fields</li>
            <li>‚Ä¢ Look for hardcoded credentials in source code</li>
          </ul>
        </Card>
      </div>
    </div>
  );
};

export default VulnerabilityTest;

function VulnerableFormInline() {
  const { toast } = useToast();
  const [formData, setFormData] = useState({
    email: "",
    creditCard: "",
  });
  
  const [errors, setErrors] = useState({
    email: "",
    creditCard: "",
  });
  
  const [touched, setTouched] = useState({
    email: false,
    creditCard: false,
  });

  // Validate email on blur
  const handleEmailBlur = () => {
    setTouched({ ...touched, email: true });
    
    if (!formData.email) {
      setErrors({ ...errors, email: "Email is required." });
    } else if (!validateEmail(formData.email)) {
      setErrors({ ...errors, email: "Please enter a valid email address." });
    } else {
      setErrors({ ...errors, email: "" });
    }
  };

  // Handle email input change
  const handleEmailChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setFormData({ ...formData, email: value });
    
    // Clear error if typing after validation
    if (touched.email) {
      if (value && validateEmail(value)) {
        setErrors({ ...errors, email: "" });
      }
    }
  };

  // Handle credit card input with PAN detection and sanitization
  const handleCreditCardChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    
    // Detect and block PAN-like inputs
    const { sanitized, isPANDetected } = sanitizeCreditCardInput(value);
    
    if (isPANDetected) {
      setErrors({ 
        ...errors, 
        creditCard: "‚ö†Ô∏è Do not enter full card numbers. This is not a secure payment form. Enter a reference (e.g., 'last 4 digits: 1234') instead." 
      });
      setTouched({ ...touched, creditCard: true });
      // Do not store PAN in state
      setFormData({ ...formData, creditCard: "" });
    } else {
      setFormData({ ...formData, creditCard: sanitized });
      
      // Clear error if valid reference provided
      if (touched.creditCard && sanitized.length > 0) {
        setErrors({ ...errors, creditCard: "" });
      }
    }
  };

  // Validate credit card on blur
  const handleCreditCardBlur = () => {
    setTouched({ ...touched, creditCard: true });
    
    if (!formData.creditCard) {
      setErrors({ ...errors, creditCard: "Please enter a payment reference or last 4 digits." });
    } else if (looksLikePAN(formData.creditCard)) {
      setErrors({ 
        ...errors, 
        creditCard: "‚ö†Ô∏è Do not enter full card numbers. Enter a reference instead." 
      });
    } else {
      setErrors({ ...errors, creditCard: "" });
    }
  };

  // Validate and submit form
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    // Mark all fields as touched
    setTouched({ email: true, creditCard: true });
    
    // Validate email
    let emailError = "";
    if (!formData.email) {
      emailError = "Email is required.";
    } else if (!validateEmail(formData.email)) {
      emailError = "Please enter a valid email address.";
    }
    
    // Validate credit card field (should not contain PAN)
    let creditCardError = "";
    if (!formData.creditCard) {
      creditCardError = "Please enter a payment reference or last 4 digits.";
    } else if (looksLikePAN(formData.creditCard)) {
      creditCardError = "‚ö†Ô∏è Do not enter full card numbers. This form is not PCI-compliant.";
    }
    
    setErrors({ email: emailError, creditCard: creditCardError });
    
    // Block submission if errors exist
    if (emailError || creditCardError) {
      toast({ 
        title: "Validation Failed", 
        description: "Please correct the errors before submitting.",
        variant: "destructive"
      });
      return;
    }
    
    // Success - all validations passed
    toast({ 
      title: "Form Submitted Successfully", 
      description: "Your information has been validated and accepted." 
    });
    
    // Reset form
    setFormData({ email: "", creditCard: "" });
    setTouched({ email: false, creditCard: false });
    setErrors({ email: "", creditCard: "" });
  };

  // Determine if form is valid
  const isFormValid = 
    formData.email && 
    validateEmail(formData.email) && 
    formData.creditCard && 
    !looksLikePAN(formData.creditCard) &&
    !errors.email &&
    !errors.creditCard;

  return (
    <Card className="p-6 max-w-2xl mx-auto">
      <h3 className="text-xl font-bold mb-4">‚úÖ Secured Contact Form</h3>
      <p className="text-muted-foreground mb-4">This form now includes proper validation and PAN detection.</p>
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label htmlFor="email-input" className="text-sm font-medium mb-2 block">
            Email <span className="text-destructive">*</span>
          </label>
          <Input
            id="email-input"
            type="email"
            name="email"
            autoComplete="email"
            value={formData.email}
            onChange={handleEmailChange}
            onBlur={handleEmailBlur}
            placeholder="user@example.com"
            maxLength={254}
            aria-invalid={touched.email && !!errors.email}
            aria-describedby={errors.email ? "email-error" : undefined}
            className={touched.email && errors.email ? "border-destructive" : ""}
          />
          {touched.email && errors.email && (
            <p id="email-error" className="text-sm text-destructive mt-1" role="alert">
              {errors.email}
            </p>
          )}
        </div>
        
        <div>
          <label htmlFor="creditcard-input" className="text-sm font-medium mb-2 block">
            Payment Reference <span className="text-destructive">*</span>
          </label>
          <p className="text-xs text-muted-foreground mb-2">
            ‚ö†Ô∏è Do not enter full card numbers. Provide a reference like "last 4: 1234" or transaction ID.
          </p>
          <Input
            id="creditcard-input"
            type="text"
            name="creditCard"
            autoComplete="off"
            inputMode="text"
            value={formData.creditCard}
            onChange={handleCreditCardChange}
            onBlur={handleCreditCardBlur}
            placeholder="e.g., 'Ref: TX-1234' or 'Last 4: 5678'"
            maxLength={50}
            aria-invalid={touched.creditCard && !!errors.creditCard}
            aria-describedby={errors.creditCard ? "creditcard-error" : undefined}
            className={touched.creditCard && errors.creditCard ? "border-destructive" : ""}
          />
          {touched.creditCard && errors.creditCard && (
            <p id="creditcard-error" className="text-sm text-destructive mt-1" role="alert">
              {errors.creditCard}
            </p>
          )}
        </div>
        
        <Button 
          type="submit" 
          className="w-full"
          disabled={!isFormValid}
        >
          {isFormValid ? "Submit Securely" : "Complete Required Fields"}
        </Button>
      </form>
      
      <div className="mt-6 p-4 bg-green-500/10 border border-green-500 rounded">
        <h4 className="font-bold text-green-700 dark:text-green-400 mb-2">‚úÖ Security Improvements Implemented (2)</h4>
        <ul className="text-sm space-y-1 text-green-700 dark:text-green-400">
          <li>‚úì Email format validated (RFC-5322-lite)</li>
          <li>‚úì PAN detection with Luhn check prevents card number entry</li>
          <li>‚úì Real-time validation with accessible error messages</li>
          <li>‚úì Submit button disabled until inputs are valid</li>
        </ul>
      </div>
    </Card>
  );
}
